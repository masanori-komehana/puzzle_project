# 外部仕様

本頁は装置の外部仕様について説明する。

```eval_rst
.. raw:: html

    <script>
        mermaid.initialize({
            theme: 'neutral',
        });
    </script>
```

## 概要

マイコンとLEDマトリクスを使用した、
15パズルゲームをする装置。
4ｘ4のマスの上に15個の駒がランダムに配置されていて、
駒を順番に並んだ状態に並び替え、
揃ったら、「CLEAR」の表示と揃うまでの時間を表示する。

## 外観

---

\*\* **準備中** \*\*

---

## 動作の概要

この項では装置の動作についての説明を行う。
以下に概略フローと状態遷移図を述べる。

### 概略フロー

1. 起動直後は【初期状態】で、駒がランダムにシャッフルされた状態で画面に表示されている。
2. 方向入力を受け取ると【パズル進行中】となりそれぞれのスイッチを押して駒をスライドし、駒を目的の配置にする。
3. 駒を動かしていき以下の駒配置にすることを目指す。
    ```eval_rst
    .. csv-table::
        
        1,2,3,4
        5,6,7,8
        9,10,11,12
        13,14,15,""
    ```
4. 上に示した駒配置になったときに【クリア】となり、"CLEAR"という文字列と揃うまでにかかった時間の表示を行う。
    * 揃うまでにかかった時間の定義は「初期状態から何かしらの方向入力があった瞬間から最終目標の形に揃うまでの時間」とし、図にすると以下に示す区間である。
    ```eval_rst
    .. mermaid::
        
        sequenceDiagram
            pazzle->>timer : 初期化
            Note right of timer: タイマーリセット
            Note left of pazzle: 初期状態
            pazzle->+timer : 方向入力
            Note right of timer: タイマースタート 
            Note left of pazzle: パズル進行中
            timer ->-pazzle : パズルが揃った
            Note right of timer: タイマーストップ
            timer ->> pazzle : 時間表示
    ```
5. クリアした後やパズルを解くのを諦めたいときは、初期化入力【初期状態】に移行することができる。

### 状態遷移図

前項で述べた概略フローを状態遷移図にしたものを以下に示す。
```eval_rst
.. mermaid::
    
    stateDiagram-v2
        
        [*] --> 初期状態 : 起動
        初期状態 --> パズル進行中 : 方向入力
        初期状態 --> 初期状態 : 初期化入力
        パズル進行中 --> パズル進行中 : 方向入力
        パズル進行中 --> 初期状態 : 初期化入力
        パズル進行中 --> クリア : パズルが揃う
        クリア --> クリア : 方向入力
        クリア --> 初期状態 : 初期化入力
```

## 動作の詳細
この項では、以下に示す状態の詳細を述べる。
1. 開始状態
2. パズル進行中
3. クリア

### 開始状態
この状態ではタイマーの初期化と駒のシャッフルを行い、
プレイヤー入力を待ち続けている状態である。
以下に詳細な手順を示す。

1. タイマーの初期化
    * 時間計測に用いているの変数の値を0にする。
2. 駒のシャッフル
    * ボード上の駒を揃った状態に並べる。
    * ランダムで選ばれた駒2個の組を交換する。
    * 上の手順を十分な回数でかつ偶数回行う。
        * 偶数回の交換ではスライド操作のみで完成することが保証されている。
3. 方向入力がされるまで待つ。
    * 方向入力が来たら【パズル進行中】に移行する。

### パズル進行中
この状態では、方向入力によって入力した方向に空きマスがある駒が動かすことができる。
例えば以下の駒の配置であれば、それぞれの方向入力を受け取った場合の動作は以下の通りである。
* `上`の入力が来た：`15`の駒が空きマスに移動する
* `下`の入力が来た：`7`の駒が空きマスに移動する
* `左`の入力が来た：`11`の駒が空きマスに移動する
* `右`の入力が来た：`10`の駒が空きマスに移動する


```eval_rst
.. csv-table::
    
    1,2,3,4
    5,6,7,8
    9,10,"",11
    13,14,15,12
```

以下に詳細な手順を示す。

1. 入力を受け取るまで待ち、リセット入力が来た場合は【初期状態】に移行し、方向入力が来た場合は、駒を動かす処理を行う。
2. 受け取った入力方向に動かせられる駒を探す。
3. 駒を動かす。
4. 揃った場合【クリア】にする。

### クリア
この状態では、「CLEAR」の文字列と揃うまでにかかった時間を表示する。

以下に詳細な手順を示す。

1. タイマーを止める
2. タイマーの値を取得する
3. 「CLEAR」の文字列と取得したタイマーの時間(揃うまでの時間)を表示する。
4. リセット入力を待つ。方向入力は無視する。


## 部品表

本装置に使う部品を以下に示す。
```eval_rst
.. csv-table::
    :header-rows: 1

    名称, 型番／寸法, 個数
    マイコンボード, Nucleo STM32F446RE, 1
    LEDマトリクスパネル, P6 RGB 32×32, 1
    タクトスイッチ, 1273HIM-160G-G, 4
    タクトスイッチ, ＴＶＧＰ０１－Ｇ７３ＢＢ（赤）, 1
    ピンヘッダ, 10P(2x5), 2    
    フラットケーブル, 10P(2x5), 1    
    ユニバーサル基板, 2.54mm ピッチ 155x114mm, 1    
    ユニバーサル基板, 2.54mm ピッチ 95x72mm, 1    
    ベニヤ板, 寸法, 1    
    スペーサー, 寸法, 1    
    ビス, 寸法, 1     
    ワッシャー, 寸法, 1    
    ゴム足, 寸法A 18mm B-P2S, 4-6     
    ACアダプタ, 5V3A, 1
    USB ACアダプタ, 5V1A, 1
    USB ケーブル, Ａオス－ミニＢオス, 1
```

