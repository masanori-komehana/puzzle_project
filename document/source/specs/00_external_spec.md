# 外部仕様

## 概要

マイコンとLEDマトリクスを使用した、
15パズルゲームをする装置。
4ｘ4のマスの上に15個の駒がランダムに配置されていて、
駒を順番に並んだ状態に並び替え、
揃ったら、「CLEAR」の表示と揃うまでの時間を表示する。

## 外観

---

\*\* **準備中** \*\*

---

## 動作の概要

この項では装置の動作についての説明を行う。
以下に概略フローと状態遷移図を述べる。

### 概略フロー

1. 起動直後は【初期状態】で、駒がランダムにシャッフルされた状態で画面に表示されている。
2. SW1-4を押すと【パズル進行中】となりそれぞれのスイッチを押して駒をスライドし、駒を目的の配置にする。
3. 右下の隅を空きとした以下の表のような配置を最終目標とし、その駒配置になることを「パズルが揃った」と定義する。  
    ```eval_rst
    .. csv-table::
        
        1,2,3,4
        5,6,7,8
        9,10,11,12
        13,14,15,""
    ```
4. 「パズルが揃った」ならば【クリア】となり、"CLEAR"という文字列と揃うまでにかかった時間の表示を行う。
    * 揃うまでにかかった時間は「駒がシャッフルされた後SW1-4のどれかを初めて押した瞬間から最終目標の形に揃うまでの時間」とし、シーケンス図にすると以下の灰色の四角でしめされた区間である。
    ```eval_rst
    .. mermaid::
        
        sequenceDiagram
            pazzle->>timer : 初期化
            Note right of timer: タイマーリセット
            pazzle->+timer : 駒を動かす
            Note right of timer: タイマースタート 
            timer ->-pazzle : パズルが揃った
            Note right of timer: タイマーストップ
            timer ->> pazzle : 時間表示
    ```
5. クリアした後や諦めたいときは、SW0を押し【初期状態】に戻す。

### 状態遷移図

前項で述べた概略フローを状態遷移図にしたものを以下に示す。
```eval_rst
.. mermaid::
    
    stateDiagram-v2
        
        [*] --> 初期状態 : 起動
        初期状態 --> パズル進行中 : sw1,2,3,4
        パズル進行中 --> パズル進行中 : sw1,2,3,4
        パズル進行中 --> 初期状態 : sw0
        パズル進行中 --> クリア : パズルが揃う
        クリア --> クリア : sw1,2,3,4
        クリア --> 初期状態 : sw0
```

## 動作の詳細
この項では、以下に示す状態の詳細を述べる。
1. 開始状態
2. パズル進行中
3. クリア

### 開始状態
開始状態ではタイマーの初期化と駒のシャッフルを行い、
プレイヤー入力を待ち続けている状態である。
以下に詳細な手順を示す。

1. タイマーの初期化
    * 時間計測に用いているの変数の値を0にする。
2. 駒のシャッフル
    * ボード上の駒を揃った状態に並べる。
    * ランダムで選ばれた駒2個の組を交換する。
    * 上の手順を十分な回数でかつ偶数回行う。
        * 偶数回の交換ではスライド操作のみで完成することが保証されている。
3. 方向入力がされるまで待つ。

### パズル進行中
この状態では、Sw1-4または方向入力によって入力した方向に空きマスがある駒が動かすことができる。
例えば以下の状態では右を押すと15が、下を押すと12が空きマスの駒に移動する。

```eval_rst
.. csv-table::
    
    1,2,3,4
    5,6,7,8
    9,10,11,12
    13,14,15,""
```

1. 方向入力を受け取る
2. 受け取った入力方向に動かせられる駒を探す
3. 駒を動かす。
4. 揃った場合【クリア】にする。

### クリア
この状態では、「CLEAR」の文字列と揃うまでにかかった時間を表示する。
1. タイマーを止める
2. タイマーの値を取得する
3. 「CLEAR」の文字列と取得したタイマーの時間(揃うまでの時間)を表示する。



